You are working in the GigAid Replit codebase:
- Frontend: React + Vite
- Backend: Node.js + Express
- Express serves both API + React frontend

Implement a new â€œPaste message â†’ bookedâ€ quick-flow that creates a Job Draft from pasted client text, generates a booking link, and provides a one-tap â€œSend booking linkâ€ step. Do this with minimal, safe changes and without breaking existing Jobs/Leads/Booking/Payments flows.

NON-NEGOTIABLES
- Smallest safe diff. No broad refactors.
- Feature-flag the new flow (server + client) so it can be rolled out gradually and disabled instantly.
- Do not change existing routes or data contracts unless you add new ones.
- All new endpoints must validate input and enforce auth.
- If AI parsing fails or confidence is low, fall back to a manual â€œEdit detailsâ€ screen instead of blocking.

HIGH-LEVEL UX (exact)
Entry point: A primary button visible on Dashboard and/or Jobs: â€œPaste a client messageâ€
Flow screens:
1) Paste Screen
   - Title: â€œPaste what your client sent youâ€
   - Textarea placeholder example
   - Helper text: â€œWeâ€™ll turn this into a booked job.â€
   - Primary CTA: â€œCreate Bookingâ€
2) Preview Screen (â€œHereâ€™s what we got ğŸ‘‡â€)
   - Job summary card with editable fields:
     - Service
     - Date & Time
     - Location
     - Price
   - Payment section defaulted:
     - â€œâœ” $50 deposit now / Remaining after the jobâ€
     - A â€œChangeâ€ link that reveals options: deposit %, full upfront, pay after (if supported)
   - Reminders: â€œâœ” Automatic reminders sent to your clientâ€ (no toggle here)
   - Primary CTA: â€œSend Booking Linkâ€
   - Secondary: â€œEdit detailsâ€
3) Sent Screen
   - â€œBooking link sent ğŸ‰â€
   - â€œYour client can book and pay in seconds. Youâ€™ll be notified when itâ€™s confirmed.â€
   - Bullet list:
     - â€œYouâ€™ll get a confirmationâ€
     - â€œThe appointment is added to your scheduleâ€
     - â€œReminders are sent automaticallyâ€
   - Primary: â€œDoneâ€

PART A â€” FIND & REUSE EXISTING LOGIC
1) Locate existing logic for:
   - Creating a job/lead
   - Generating/serving the public booking link
   - Creating invoices/deposits (Stripe or current payment mechanism)
   - Reminders creation/scheduling
2) Reuse existing services/utilities. Do not duplicate business rules.

PART B â€” DATA MODEL (minimal additions)
Add a â€œJobDraftâ€ concept (choose the smallest approach):
Option 1 (preferred): Create a new table/collection/entity for drafts:
- id
- user_id
- source_text (original pasted message)
- parsed_fields JSON (service, datetime, location, price, duration)
- confidence JSON (overall + per-field)
- status: 'draft' | 'link_sent' | 'booked' | 'expired'
- booking_link_url (generated)
- created_at, updated_at

Option 2: If you already have Leads or Jobs with a â€œdraftâ€ status, reuse that and add only the missing fields.

Do NOT introduce complex state machines.

PART C â€” BACKEND APIS (Express)
Implement under /api/quickbook/* with auth middleware:

1) POST /api/quickbook/parse
Purpose: Accept pasted message text and return a parsed draft preview.
Request:
- { messageText: string }
Validation:
- required, trim, 10â€“2000 chars
Response:
- { draftId, fields: { service, dateTimeStart, dateTimeEnd, locationText, priceAmount, currency, durationMins }, confidence: {...}, suggestions?: {...} }

Parsing behavior:
- Use the existing AI integration if present.
- If no AI exists, implement a rule-based fallback:
  - Detect date/time phrases (tomorrow, next Friday, 3pm) with a simple library or conservative heuristics.
  - If uncertain, return nulls + low confidence.
Confidence thresholds:
- overallConfidence >= 0.6: show preview normally
- < 0.6: still create draft, but UI should guide user to â€œEdit detailsâ€ immediately

2) PATCH /api/quickbook/draft/:id
Purpose: Update draft fields after user edits.
Request:
- partial fields object
Validation:
- enforce sane ranges (price >= 0, duration 15â€“480, date in future, etc.)
Response:
- updated draft

3) POST /api/quickbook/draft/:id/send-link
Purpose: Generate (or fetch) booking link and mark draft as link_sent.
Also record the intended payment settings (deposit/full/etc.) on the draft or related object.
Request:
- { paymentIntentConfig: { type: 'deposit'|'full'|'after', depositAmount?: number, depositPercent?: number } }
Response:
- { bookingLinkUrl }
Rules:
- Default deposit to $50 if price >= $100, else 30% if price provided, else $25.
- If payment isnâ€™t supported yet, still create bookingLinkUrl and omit payment config gracefully.

4) (Optional) POST /api/quickbook/draft/:id/mark-sent
If you need to record that the user actually sent it. Otherwise log client-side event only.

Security:
- All endpoints require authenticated user and ownership checks.
- Rate limit parse endpoint (per user) to prevent abuse.
- Sanitize messageText (no HTML rendering).

Feature flag:
- Add QUICKBOOK_ENABLED boolean in server config.
- If disabled, endpoints return 404 or {error:"disabled"}.

PART D â€” FRONTEND (React)
Add a new route: /quickbook (or a modal-driven flow)
Implement 3-step wizard with local state + API calls:

1) PasteStep component
- textarea + Create Booking button
- on submit: call POST /api/quickbook/parse
- navigate to PreviewStep with draftId

2) PreviewStep component
- fetch draft by id or use parse response
- render editable fields inline:
  - Service (select or text)
  - Date/time (picker)
  - Location (text)
  - Price (number)
- Payment section:
  - default shown as â€œâœ” $50 deposit now / Remaining after the jobâ€
  - â€œChangeâ€ reveals choices
- Primary CTA â€œSend Booking Linkâ€:
  - calls POST /api/quickbook/draft/:id/send-link with chosen payment config
  - then navigate to SentStep
- Secondary â€œEdit detailsâ€ should just focus the edit UI (no new screen needed) OR open a simple edit panel.
- If confidence low (<0.6), auto-open edit mode and show helper:
  â€œQuick check: update anything that looks off.â€

3) SentStep component
- show success copy exactly
- show bookingLinkUrl with:
  - â€œCopy linkâ€ button (clipboard API + toast â€œLink copiedâ€)
  - Optional â€œShareâ€ if mobile later (not required now)
- Done button returns to Dashboard

Entry point button:
- Add a primary button on Dashboard and/or Jobs list:
  â€œPaste a client messageâ€
- Only show if QUICKBOOK_ENABLED is true (fetched from /api/config or similar).

Tracking (only if analytics exists; otherwise add console TODO):
- quickbook_opened
- quickbook_parse_submitted
- quickbook_preview_shown (with confidence)
- quickbook_send_link_clicked
- quickbook_completed
- quickbook_copy_link_clicked

PART E â€” CUSTOMER PAYMENT PAGE TRUST COPY
On the public booking/payment page (where the client pays), add a â€œYour payment is protectedâ€ block:

Header: â€œYour payment is protectedâ€
Bullets:
- â€œYouâ€™re only charged whatâ€™s shown aboveâ€
- â€œPayments are processed securelyâ€
- â€œFunds are released after the job is completedâ€
- â€œYouâ€™ll receive reminders before your appointmentâ€
Footer: â€œSecure payments powered by Stripeâ€

If deposit:
Add below deposit amount:
â€œThis deposit secures your appointment. The remaining balance is paid after the work is done.â€

Only add this copy if a payment section exists on that page. Keep wording simple, no legalese.

PART F â€” QA CHECKLIST (must pass)
- Existing booking flow still works unchanged.
- Feature flag off: button hidden and endpoints disabled.
- Feature flag on: full quickbook flow works.
- Parse failure: user can still manually edit and proceed.
- Confetti NOT required here (separate task) unless it already exists in this flow.
- Booking link generation is valid and opens correctly.
- Copy link works and shows toast.
- All endpoints enforce auth + ownership.

DELIVERABLES
- PR-ready implementation:
  - new API routes under /api/quickbook
  - new React route /quickbook or a modal wizard
  - minimal updates to Dashboard for entry button
  - trust copy block added to public payment page
- Add short comments at integration points explaining why.

Proceed carefully:
1) Locate existing booking link + job creation services
2) Implement draft storage (reuse existing entity if possible)
3) Add parse endpoint with AI + fallback
4) Build the 3-step UI
5) Add send-link endpoint and connect UI
6) Add trust copy to payment page
7) Run through QA checklist and fix regressions
